version: '3.8'

services:
  # 0. Caddy Reverse Proxy (HTTPS)
  caddy:
    image: caddy:2-alpine
    container_name: siphon-caddy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - trade-executor
      - payload-generator
    restart: unless-stopped

  # 1. Python Trade Executor (The Manager)
  trade-executor:
    build: ./trade-executor
    container_name: siphon-trade-executor
    ports:
      - "5005:5005"
    environment:
      - FHE_ENGINE_URL=http://fhe-engine:5001/evaluateStrategy
      - PYTH_HERMES_URL=https://hermes.pyth.network
      - DATABASE_URI=sqlite:////app/data/strategies.db
      - HELIUS_API_KEY=${HELIUS_API_KEY}
      - SOLANA_NETWORK=${SOLANA_NETWORK:-devnet}
      - EXECUTOR_PRIVATE_KEY=${EXECUTOR_PRIVATE_KEY}
    volumes:
      - trade-executor-data:/app/data
    depends_on:
      - fhe-engine
    restart: unless-stopped

  # 2. Rust FHE Engine (The Calculator)
  fhe-engine:
    build: ./fhe
    container_name: syphon-fhe-engine
    ports:
      - "5001:5001"
    environment:
      - RUST_LOG=info
    restart: unless-stopped

  # 3. Rust Payload Generator (The Encryptor)
  payload-generator:
    build: ./siphon-payload-generator-demo
    container_name: siphon-payload-generator
    ports:
      - "5009:5009"
    environment:
      - RUST_LOG=info
      - ORCHESTRATOR_URL=http://trade-executor:5005/createStrategy
    depends_on:
      - trade-executor
    restart: unless-stopped

volumes:
  trade-executor-data:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
